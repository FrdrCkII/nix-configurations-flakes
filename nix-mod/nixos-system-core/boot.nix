{ lib, cfg, ... }:
lib.mkMerge [
  {
    boot = {
      supportedFilesystems = {
        ext4 = true;
        btrfs = true;
        ntfs = true;
        fat = true;
        vfat = true;
        exfat = true;
      };
      kernelParams = [
        "video=1920x1080@60"
        "loglevel=5"
        "elevator=deadline"
        "slab_nomerge"
        "init_on_alloc=1"
        "page_alloc.shuffle=1"
        "vsyscall=none"
      ];
    };
  }

  (lib.mkIf (cfg.opt.boot.loader == "grub") {
    boot.loader = {
      efi.canTouchEfiVariables = true;
      efi.efiSysMountPoint = lib.mkDefault "/boot/efi";
      grub = {
        enable = true;
        device = lib.mkDefault "nodev";
        efiSupport = lib.mkDefault true;
        gfxmodeEfi = lib.mkDefault "1920x1080@60";
        gfxpayloadEfi = lib.mkDefault "keep";
        configurationName = lib.mkDefault "GRUB";
        theme = lib.mkForce null;
        users."grub".hashedPassword =
          "grub.pbkdf2.sha512.1000.7D4488CB8F612E1007AF68DF371B7C782709983B0B0D7C087FA0561AA9ACB645998193F7DDA6202FB40DDCE7860098C380598138363F2F410A11578568E4E6BB43E8104E3A781867DE5212C50566CD7733EB709B4F12D1F740916342C3C7D0E290FFB5B6D83FFABA23093F61A6D71C1B038FEC8621DDF2B973D9D0DFA6B68E63ECB64E17B8DD1DD14DEDCFA93B0E67AD637DBB5351B73E7DAED15E6B8D9E4C96F991B4C3F6224961C3C2E7763D572E14AC12816DCFADCE97E1409B5AB7DEC7235B5F3D18E15E8CC4E3E3F5D14BAB8AFBBECF15BA96E9AB2E237E1A7EE6BB5FC380295FD2E5AF68D87844EC2C8B30B28F055C00F6CE8179A4827D760478E48FC62ABBA1F7AAE5109C30E73BD3CCBC5D0D25C47E1C3A0F685E91733AED812DF8254167E3B376CBADE609426C7AEC05AC319D2439C36A679F4F906FD9233AED0DDDA4CCFE2AE8210D2017399B702DD05D313E3BED0E1456AE66B050A50345CFE5936D4384512027F7228A29ECF8CCB93C2DA11ABFEAE79191870DA8552087ADDC903BEC5CA278298F992D69F53F474E8EA5A78E4997C69BC59CF9FDDCB7064E4A63EED96866397AA91CD85C28A35A9080B472400EDC2E8261BD817AA01EBCF202700E376D6B5DC3F8652B37CDE7AE6A56DDDA55A7BF5F8DABE1C187A0BF7AFF5437A758C59100055678BEFE2612E7AAFB74C67770BCD6C2416001A4114BD50174F8585D7FEB3948E33F55E7EB3141DD0FE0B5F679E93ED88473CEF3798653615743038DB021C37763E6B2BF87D4D94C0F911957FAC7418E0E45D0A0A14091E000E73067396DAF18F0AD7C7E871CFF2B47C5EEE3005D8547F2199FA997773FE96FBAE98A70BBECFAB59F2B4D739CE60E62BE1D79B0E28128BB8ED38DF1592FA21B5932DEC0D728415533EE1567B568774779D0BF480DF5C908962CC79B706376648DBF9CC7A649643C462E55B0E3CE5065EE59B1C753C9F6B92CB5FE4631FAF11C46F77CE6349789178F395C4B3CFD1A82E91A68E6F4896D8196CA71B8E9453BEFA5F89D1E188258AEAA74A21E02768541D4A1EB18CAA150EA9738D1E327060E944F03C880A9A750A771016E884B3C49CC9F895CAD3A5BF2BC2BC234DB8D327F150B683F7E3AFA6220F0FB6594CA05DA9D677151EB8C19A885D5197475908DE5D3C4F4C65D8FB4A255B4F301AD108D1AD3DC58C2C99E1C4DF648C14E74C651580EFDCF87458659D7B833C972C325FF583F6F3B9A7A69E8261E3F6FE81E9E5BF734D9C17656681A413EDF249B2D5F52BA8B6FD0C5227D63D73BBB77244734E7844D0BE0EAA136676305783F4EF243B8173D3D908D8A6EE0D9946946D33B70B4AB17C455E4169F37B5E5316B362A72230F472F788510E0BA6FE568119AB33D4AA763787345A96BB0C587BA.88EDB85F304F86400302FAE31DAEE550FA0488339E3AD7D424DE41E8C0561D811AA68E68909D2CD8A21E427A5301D113338C48029CFDFDA61BEA05A6FBB35077E91E10C8CDA2C9AF683AE5A8F9390E02A81326FB52C8D09F2B0642554DC0C654142E0BF3D2D301929CAA52FE3120C8771745E6B1578D5AA2D1D4B4DF110C6806FCA0D9F2CEF6E123936186B0FE6297E1C3A28F43B8F67D9D59E70655657BA4FE895E0E9E42B3E32436C9831EBA7E0B01345D93D734F8086AAB51124AAF345EAA1D9A154CED29B14A7F5F6400F09899D45E3BA00AFB83881EF042F66C14A3B6DE502CD3EAF8832C31E24646B271BC9D40A9EBA31081C928FD0862D44CA130C9FB9DD11DFCE940B3847350B2B6809026195C2B16CA3CC52AB9CAD1A3C6A45D7D1587E6BD25FA0F957F741F16DDA8B11BCB18A41B01CC1384BA38EC8CD84A60D5E2E2A98109891186054357CFC1FEC3E09114746117EEB4E88679798BD9EC3FA4AF98D0E11B7DD205E7E5DA4798ADBA8A965D69DED636C400A3D8F26584F04F4B91CF287482DFEFA00EC6647C60362B7C1499F658BDAD9952F41E6875DC36EA7889AE9A7B2B76B3FD8B52D3110819B50F6CE9B356B6C042123DAC5CDAE7ECC93734120177F3B3021EBAB211A0DBF89BFB73CF9699F798DD6DD091951142F8C3FCA63F06775BDA1A2B11F45CF61C79A8DFAAD288393D4BF221F546EEB5C291DF2109CEF3B258BD2FECF70F9A3A813DACDE2028156B7E8B7BD5D1AC2800E4BB5C4DB84D7A29373C1439DD9D73156510CF41710C9AFD5E30A412A5425778B28110CEA01C5F5373F5821CBBAF178A21957F0126C46DD30E3AC7991D2D82C3F93CED913A8FA6D5E8D1EEFF42539F49E0C4D134093751B6B8B0B9E04BE69FF20AE84CAB67A57AECFA37C65606FE02723C6737852390E6471D01FC6B70335B418CB082E6C82B454C1F92C4B19A154002FBC6AAC1A16EC88B8FA71AD9E45436CFF8696A52F212B3CD89DF454E29C4AD3AF56BE2422CD023C644C32C614BF86C0206316F8B9226E86A208E772A17836D466A8E18FAD894CB1D5BB9423FA34A85FF341EA9AED7D5C40499DA2424FCB6D0093C1B12F57B3F01672810CE5C97FD04F407052C425567437C9CFC7306DA96CD9FEFC193D32AD4F6F11D9AF87D8522C02E89929F40B6829FCF9BA25B53BF1B5CD91BB42EC4CA893FB650526993FB261AEE20D3178B1A76B579FE3B5801E2360E1D503677F141B5D773EC358C57E0B2B5E0020ECAB78F2EFEE19FEEABA8C044F6A5DF9AC59CA863B7488703E60EDA8186FA2B0F377A96B2688607DD0666C25CA3B620ECF94B8D79E88DB47BD0B3FF0C290F4DAC9D4CE5998D5EE00FCD56E6957049BF054AA23009319880E2C89499B9193A08FE070E620677CF38489BC888";
        extraConfig = ''
          set superusers='grub'
        '';
      };

    };
  })

  (lib.mkIf (cfg.opt.boot.loader == "systemd-boot") {
    boot.loader = {
      efi.canTouchEfiVariables = true;
      efi.efiSysMountPoint = lib.mkDefault "/boot/efi";
      systemd-boot = {
        enable = true;
        consoleMode = "keep";
      };
    };
  })

  (lib.mkIf (cfg.opt.boot.efi-mount-point != null) {
    boot.loader.efi.efiSysMountPoint = cfg.opt.boot.efi-mount-point;
  })

]
